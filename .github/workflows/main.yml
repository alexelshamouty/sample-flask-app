# This is a basic workflow to help you get started with Actions

name: BUILD
env:
  GCP_PROJECT_ID: " myapp-341118 "
  GKE_CLUSTER_NAME: "myappcluster"
  GCP_REGION: "europe-west4"

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the main branch
  pull_request:
    branches: [ main ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2

      - name: Install tools
        run: |
          wget -q https://github.com/mozilla/sops/releases/download/v3.7.1/sops-v3.7.1.linux -O /usr/local/bin/sops
          chmod a+x /usr/local/bin/sops
          
          wget -q https://get.helm.sh/helm-v3.8.0-linux-amd64.tar.gz -O- | tar -xz --strip-components=1 -C /usr/local/bin
          chmod a+x /usr/local/bin/helm
          
          wget -q https://github.com/roboll/helmfile/releases/download/v0.143.0/helmfile_linux_amd64 -O /usr/local/bin/helmfile
          chmod a+x /usr/local/bin/helmfile
          
          wget  -q "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl" -O /usr/local/bin/kubectl
          chmod a+x /usr/local/bin/kubectl
          
          helm plugin install https://github.com/jkroepke/helm-secrets
          helm plugin install https://github.com/databus23/helm-diff

      # Runs a single command using the runners shell
      - name: Run Docker build
        run: docker build . -t myapp:${GITHUB_SHA}

      # Runs a set of commands using the runners shell
      - name: Run tests
        run: |
          echo Running checks
          docker run myapp:${GITHUB_SHA} '/app/checks.sh'

      - name: Setup Gcloud
        uses: google-github-actions/setup-gcloud@v0
        with:
          service_account_key: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Check that we have access to the cluster
        run: |
          gcloud info
